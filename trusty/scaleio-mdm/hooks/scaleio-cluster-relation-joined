#!/bin/bash
my_dir="$(dirname "$0")"
. "$my_dir/common"

log-relation "ScaleIO Standby MDM joining"

cluster_count=`leader-get cluster_count`
mdm_ips=`leader-get mdm_ips`
if [ -z $cluster_count ]
then
	log-relation "ScaleIO Standby MDM can't join - cluster isn't ready"
	exit
fi

remote_name=${JUJU_REMOTE_UNIT/\//-} 
remote_ip=`relation-get private-address`
relation_cluster_ids=`relation-ids scaleio-cluster`

juju-log "ScaleIO Standby MDM joined: $remote_name"
juju-log "ScaleIO Cluster ids: $relation_cluster_ids"

is_manager=$((cluster_count % 2))
if [ $is_manager -eq 1 ]
then
	role='manager'
else
	role='tb'
fi
cluster-cmd "class { 'scaleio::mdm': name=>'$remote_name', ips=>'$remote_ip', role=>'$role' }"

cluster_count=cluster_count+1
mdm_ips="$mdm_ips,$remote_ip"

log-relation "ScaleIO Standby MDM added as $role"
