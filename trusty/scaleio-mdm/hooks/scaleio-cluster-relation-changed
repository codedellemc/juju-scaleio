#!/bin/bash
my_dir="$(dirname "$0")"
. "$my_dir/common"

log-relation "ScaleIO Standby MDM joining"
leader=`is-leader`
remote_name=$(convert-name $JUJU_REMOTE_UNIT)

if [ $leader == 'True' ]; then
	role=`relation-get role_$remote_name`
	state=`relation-get state_$remote_name`
else
	role=`relation-get role`
	state=`relation-get state`
fi

juju-log "STATE AND ROLE in $MY_NAME: $role, $state"

if [ $leader == 'True' ] ; then
	log-relation "ScaleIO cluster-relation-changed, leader-side"
	
	adjust-cluster
else
	log-relation "ScaleIO cluster-relation-changed, slave-side" 

	eval `leader-get requested_nodes`
	requested_role=${requested_nodes[$MY_NAME]}
	if [ -n "$requested_role" ]; then
		if [[ $requested_role == slave ]]; then
			is_manager=1
			relation-set management_ip=$MY_MANAGEMENT_IP
		else
			is_manager=0
		fi
		# Remove it from list of standbies first, just in case error occurred in previous cluster adjustments
		cluster-cmd "scaleio::mdm { 'remove from cluster': name=>'$MY_NAME', ensure=>'absent' }"
		server-cmd "class { 'scaleio::mdm_server': is_manager=>$is_manager }"
		relation-set role=$requested_role
		status-set active
		juju-log "ScaleIO MDM $MY_NAME changed role to $requested_role"
	fi
fi
