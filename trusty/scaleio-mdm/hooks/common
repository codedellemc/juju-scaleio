#!/bin/bash
my_dir="$(dirname "$0")"
set -eu

if [ $# -eq 1 ] && [ $1 == "-d" ] ; then
	. "$my_dir/debug"
fi

function convert-name {
	echo ${1//[-\/]/_}
}

MY_IP=`unit-get private-address`
MY_NAME=$(convert-name $JUJU_UNIT_NAME)
echo $MY_NAME
MY_PASSWORD=`config-get password`
MY_MDMS=`leader-get mdm_ips`
if [ -z "$MY_MDMS" ]; then MY_MDMS='127.0.0.1'; fi

function server-cmd {
	juju-log "Running server-cmd with '$1'"
	set +e
	FACTER_mdm_ips=$MY_MDMS puppet apply -e "$1" --detailed-exitcodes
	local exit_code=$?
  if [[ $exit_code == 0 || $exit_code == 2 ]]; then
    juju-log "The run succeeded. Exit code is $exit_code."
  else
    juju-log "The run failed. Exit code is $exit_code."
    exit 1
  fi
	set -e
}

function cluster-cmd {
	server-cmd "scaleio::login {'login': password=>$MY_PASSWORD} -> $1"
}

function log-relation {
	rel_name=${convert-name $JUJU_REMOTE_UNIT}
	rel_ip=`relation-get private-address`
	juju-log "$1: my name is $MY_NAME, relation is $rel_name, $rel_ip"
}

function resize-cluster {
	# Check and adjust cluster size - should be called from leader only
	# TODO: Currently only 3-node cluster is checked and only growth is supported
	cluster_mode=`config-get cluster-mode`
	current_mode=`leader-get cluster_mode`
	ready_standbies=`leader-get ready_standbies`
	commas=${ready_standbies//[^,]}
	standbies_count=${#commas}
	if [[ $current_mode != $cluster_mode ]] && (( (cluster_mode-current_mode) == standbies_count )); then
		tb_count=`leader-get tb_count`
		manager_count=`leader-get manager_count`
		mdm_ips=`leader-get mdm_ips`
		slaves=`leader-get managers`
		slaves=${slaves%,}
		tbs=`leader-get tbs`
		tbs=${tbs%,}
		juju-log "ScaleIO cluster is being resized to $cluster_mode - ips: $mdm_ips, slaves: $slaves, tbs: $tbs"
		cluster-cmd "scaleio::cluster {'cluster': \
			cluster_mode=>'$cluster_mode', slave_names=>'$slaves', tb_names=>'$tbs' }"
		juju-log "ScaleIO cluster $cluster_mode is created - ips: $mdm_ips, slaves: $slaves, tbs: $tbs"
		tb_count=$((tb_count-standbies_count/2))
		manager_count=$((manager_count-standbies_count/2))
		leader-set resize_cluster=False tbs='' managers='' ready_standbies=' ' tb_count=$tb_count \
			manager_count=$manager_count cluster_mode=$cluster_mode
	fi
}
